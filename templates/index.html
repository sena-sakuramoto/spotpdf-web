{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-upload me-2"></i>PDFファイルアップロード</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <!-- Old PDF Upload -->
                    <div class="mb-3">
                        <label class="form-label">比較元PDF（古いバージョン）</label>
                        <div class="drag-drop-area" data-target="old_pdf">
                            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                            <p>ファイルをドラッグ&ドロップまたは<br>クリックして選択</p>
                            <input type="file" name="old_pdf" accept=".pdf" class="d-none">
                        </div>
                        <div class="file-info" id="old_pdf_info"></div>
                    </div>

                    <!-- New PDF Upload -->
                    <div class="mb-3">
                        <label class="form-label">比較先PDF（新しいバージョン）</label>
                        <div class="drag-drop-area" data-target="new_pdf">
                            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                            <p>ファイルをドラッグ&ドロップまたは<br>クリックして選択</p>
                            <input type="file" name="new_pdf" accept=".pdf" class="d-none">
                        </div>
                        <div class="file-info" id="new_pdf_info"></div>
                    </div>

                    <!-- Settings -->
                    <div class="mb-3">
                        <label class="form-label">差分検出感度</label>
                        <input type="range" class="form-range" name="sensitivity" min="1" max="50" value="10" id="sensitivityRange">
                        <div class="d-flex justify-content-between small text-muted">
                            <span>高感度</span>
                            <span id="sensitivityValue">10</span>
                            <span>低感度</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">表示フィルタ</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="show_added" id="showAdded" checked>
                            <label class="form-check-label" for="showAdded">
                                <span class="badge bg-success">追加部分を表示</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="show_removed" id="showRemoved" checked>
                            <label class="form-check-label" for="showRemoved">
                                <span class="badge bg-danger">削除部分を表示</span>
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="export_all" id="exportAll">
                            <label class="form-check-label" for="exportAll">
                                すべてのパターンをエクスポート
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100" disabled id="compareBtn">
                        <i class="fas fa-search me-2"></i>比較実行
                    </button>
                </form>

                <div class="loading-spinner mt-3">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">処理中...</span>
                        </div>
                    </div>
                    <p class="mt-2 text-center">PDF比較処理中...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="results-section">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-search me-2"></i>比較結果</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="prevPageBtn">
                            <i class="fas fa-chevron-left"></i> 前
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="nextPageBtn">
                            次 <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="page-navigation mb-3">
                        <div class="row align-items-center">
                            <div class="col">
                                <span class="fw-bold">ページ <span id="currentPage">1</span> / <span id="totalPages">1</span></span>
                            </div>
                            <div class="col-auto">
                                <div class="btn-group" role="group" size="sm">
                                    <button type="button" class="btn btn-outline-primary btn-sm" data-view="added">
                                        <span class="badge bg-success">追加</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm active" data-view="both">
                                        重複表示
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" data-view="removed">
                                        <span class="badge bg-danger">削除</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="diff-viewer" id="diffViewer">
                        <div class="text-center p-4">
                            <p class="text-muted">比較結果がここに表示されます</p>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="row">
                            <div class="col">
                                <button type="button" class="btn btn-success" id="downloadImages" disabled>
                                    <i class="fas fa-download me-2"></i>画像をダウンロード
                                </button>
                            </div>
                            <div class="col-auto">
                                <button type="button" class="btn btn-primary" id="downloadPDF" disabled>
                                    <i class="fas fa-file-pdf me-2"></i>PDFレポート
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentResults = null;
    let currentPage = 1;
    let currentView = 'both';

    // File upload handlers
    document.querySelectorAll('.drag-drop-area').forEach(area => {
        const input = area.querySelector('input[type="file"]');
        
        area.addEventListener('click', () => input.click());
        
        area.addEventListener('dragover', (e) => {
            e.preventDefault();
            area.classList.add('dragover');
        });
        
        area.addEventListener('dragleave', () => {
            area.classList.remove('dragover');
        });
        
        area.addEventListener('drop', (e) => {
            e.preventDefault();
            area.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                input.files = files;
                updateFileInfo(input, area.dataset.target);
            }
        });
        
        input.addEventListener('change', () => {
            updateFileInfo(input, area.dataset.target);
        });
    });

    function updateFileInfo(input, targetId) {
        const fileInfo = document.getElementById(targetId + '_info');
        if (input.files.length > 0) {
            const file = input.files[0];
            fileInfo.innerHTML = `
                <i class="fas fa-file-pdf text-danger me-2"></i>
                <strong>${file.name}</strong><br>
                <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
            `;
            fileInfo.style.display = 'block';
        } else {
            fileInfo.style.display = 'none';
        }
        
        updateCompareButton();
    }

    function updateCompareButton() {
        const oldPdf = document.querySelector('input[name="old_pdf"]').files.length > 0;
        const newPdf = document.querySelector('input[name="new_pdf"]').files.length > 0;
        document.getElementById('compareBtn').disabled = !(oldPdf && newPdf);
    }

    // Sensitivity slider
    document.getElementById('sensitivityRange').addEventListener('input', (e) => {
        document.getElementById('sensitivityValue').textContent = e.target.value;
    });

    // Form submission
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        showLoading(true);
        document.getElementById('compareBtn').disabled = true;
        
        try {
            const formData = new FormData(e.target);
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                currentResults = result.results;
                displayResults(result);
                showAlert('比較が完了しました！', 'success');
            } else {
                showAlert(result.error || '比較処理に失敗しました');
            }
        } catch (error) {
            showAlert('処理中にエラーが発生しました: ' + error.message);
        } finally {
            showLoading(false);
            updateCompareButton();
        }
    });

    function displayResults(result) {
        document.querySelector('.results-section').style.display = 'block';
        
        if (result.results && result.results.diff_images) {
            const images = result.results.diff_images;
            document.getElementById('totalPages').textContent = images.length || 1;
            currentPage = 1;
            updateDiffViewer();
        }
    }

    function updateDiffViewer() {
        if (!currentResults || !currentResults.diff_images) return;
        
        const viewer = document.getElementById('diffViewer');
        const images = currentResults.diff_images;
        
        if (images.length === 0) {
            viewer.innerHTML = '<div class="text-center p-4"><p class="text-muted">差分が検出されませんでした</p></div>';
            return;
        }
        
        const imageData = images[currentPage - 1];
        let imagePath = '';
        
        switch(currentView) {
            case 'added':
                imagePath = imageData.added;
                break;
            case 'removed':
                imagePath = imageData.removed;
                break;
            default:
                imagePath = imageData.both;
        }
        
        viewer.innerHTML = `
            <img src="/static/${imagePath}" class="diff-image" alt="差分画像 - ページ ${currentPage}">
        `;
        
        document.getElementById('currentPage').textContent = currentPage;
        document.getElementById('prevPageBtn').disabled = currentPage <= 1;
        document.getElementById('nextPageBtn').disabled = currentPage >= images.length;
        document.getElementById('downloadImages').disabled = false;
        document.getElementById('downloadPDF').disabled = false;
    }

    // Navigation
    document.getElementById('prevPageBtn').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            updateDiffViewer();
        }
    });

    document.getElementById('nextPageBtn').addEventListener('click', () => {
        if (currentResults && currentPage < currentResults.diff_images.length) {
            currentPage++;
            updateDiffViewer();
        }
    });

    // View switcher
    document.querySelectorAll('[data-view]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            currentView = e.target.dataset.view;
            updateDiffViewer();
        });
    });

    // Download handlers
    document.getElementById('downloadPDF').addEventListener('click', () => {
        if (currentResults && currentResults.summary_pdf) {
            window.open(`/download/${currentResults.summary_pdf}`, '_blank');
        }
    });

    document.getElementById('downloadImages').addEventListener('click', () => {
        // Create download links for all images
        if (currentResults && currentResults.diff_images) {
            currentResults.diff_images.forEach((imageData, index) => {
                ['added', 'removed', 'both'].forEach(type => {
                    if (imageData[type]) {
                        const a = document.createElement('a');
                        a.href = `/download/${imageData[type]}`;
                        a.download = `page_${index + 1}_${type}.png`;
                        a.click();
                    }
                });
            });
        }
    });
</script>
{% endblock %}