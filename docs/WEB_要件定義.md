# SpotPDF Web版 要件定義書（v0.1）

最終更新: 2025-08-30
作成対象: 既存PDF差分チェック（SpotPDF）のWeb版提供

## 1. 概要
- 目的: デスクトップ配布からWeb提供へ移行し、配布・更新コストを削減。認証により利用者を制限し、PDF差分（ピクセルレベル）をブラウザで確認・ダウンロードできるようにする。
- 背景: 既存は配布型（EXE）。Google認証＋スプレッドシートで許可ユーザーを管理する仕組みがある。
- 成果物: FlaskベースのWebアプリ＋Docker/Compose/Nginx構成、要件を満たすUI・API・監視・セキュリティ設定。

## 2. スコープ
- In-scope:
  - Google OAuth2ログイン（許可ユーザーリストはGoogle Sheets管理）
  - PDFアップロード（2ファイル）→ピクセル差分処理→結果表示/ダウンロード
  - 結果の一時保存（画像・統合PDF）と保持期間設定
  - 基本的な利用ログ出力・ヘルスチェック
  - Docker/Composeでの起動、Nginxによるリバースプロキシ/SSL終端
- Out-of-scope（初期段階）:
  - テキスト差分、OCR、注釈差分などの高度な解析
  - 組織/部署単位の権限分離、多テナント
  - Web上でのユーザー管理画面（管理は引き続きGoogle Sheets）

## 3. 利用者・前提条件
- 想定利用者: 社内/招待利用者
- 前提: Googleアカウント保有。許可ユーザーとしてスプレッドシートに登録済み（メール/有効期限）。
- 対応ブラウザ: 最新のChrome/Edge（Safari/Firefoxは優先度低で対応）

## 4. 用語
- 許可ユーザー: Google Sheetsに登録済みで有効期限内のユーザー
- 差分画像: 差分を色分け（追加=緑/削除=赤）で重畳したPNG
- 統合PDF: 差分画像を1本のPDFにまとめたもの

## 5. 機能要件（FR）
### 5.1 認証/認可
- Google OAuth2（Google Identity Services）でログイン。
- サーバ側でIDトークンを検証し、メールを取得。
- サービスアカウントでGoogle Sheetsを参照し、当該メールが存在かつ有効期限内であることをチェック。
- 認証状態はサーバセッションで保持（Cookie SameSite=Lax/HttpOnly/Secure）。
- ログアウト機能を提供。

### 5.2 ファイルアップロード
- 比較元（旧版）PDFと比較先（新版）PDFの2ファイル必須。
- 制限: PDFのみ/各50MB以下/最大ページ数（例: 50ページ程度）
- フロントでファイル名とサイズ表示、Drag & Drop対応。
- サーバ側でサイズ超過・拡張子・MIMEチェックを実施。超過/不正は400で応答。

### 5.3 差分処理
- PixelDiffDetectorで300DPIレンダリング・ピクセル差分を計算。
- 設定パラメータ:
  - 感度（しきい値）: 1–50（初期値10）
  - 表示フィルタ: 追加/削除/両方
  - エクスポート: すべてのパターン（両方/追加/削除） or 選択パターンのみ
- 成果物:
  - ページ単位の差分PNG
  - まとめPDF（差分画像を統合）
  - 変更ピクセル数合計（メタ情報）
- エラー時は500でJSONエラー返却。アップロード一時領域は必ずクリーンアップ。

### 5.4 結果表示/ダウンロード
- ブラウザUI: ページ送り、表示フィルタ切替、件数表示。
- ダウンロード:
  - 統合PDFをダウンロード
  - 差分PNGはまとめてZIPでダウンロード（要件）
- パス安全性: ダウンロード対象はサーバ設定の出力ディレクトリ配下のみ。

### 5.5 管理/運用
- 許可ユーザーの管理はGoogle Sheetsで継続（email/expiration_date）。
- 基本ログ: 認証結果、アップロード/処理/エラー、ダウンロードを記録（ユーザー、時刻、処理時間、件数）。
- 保持期間: ログ30日、差分出力7日（環境変数で調整可能）。

### 5.6 ヘルスチェック/状態
- GET /status: 認証状態（ログイン済み/ユーザー名）をJSONで返却。ヘルスチェック用に未認証でも200返却可。

## 6. 非機能要件（NFR）
### 6.1 性能/容量
- 入力: 最大50MB×2、ページ数最大50（目安）。
- 応答: 20ページ・画像中心のPDFで60秒以内（CPU 2vCPU/4GBメモリ想定）。
- 同時実行: 1ユーザーあたり同時2ジョブまで（超過は429）。

### 6.2 スケーラビリティ
- Flaskスレッド/WSGIワーカー増設で水平拡張可能（将来は非同期/ジョブキュー検討）。

### 6.3 セキュリティ
- 秘密情報（Client Secret/Service Account Key/Flask SECRET_KEY）は環境変数/秘密ストアで管理。リポジトリ配布禁止。
- CSRF: セッション＋同一サイトCookie/SameSite=Laxを使用。状態変更APIにCSRF対策（必要に応じてトークン）。
- アップロード: 拡張子＋MIME検査、サイズ検査、保存先は一時領域、処理後削除。
- パス検証: ダウンロード時はディレクトリトラバーサル防止（正規化・検証）。
- レート制限: IP/User単位でAPI呼び出し数制限（例: 10 req/min、アップロードは2/min）。
- ログ: 機密は記録しない。ユーザー識別子（メール）・時刻・ステータス・処理統計に限定。
- ヘッダー: Nginxでセキュリティヘッダー（CSP、X-Content-Type-Options、Referrer-Policy等）。

### 6.4 可用性/運用
- 稼働: 99.5%/月（目標）。
- 監視: ヘルスチェック、エラーログ監視、ディスク残量（出力/ログ）。
- バックアップ: 許可ユーザーのスプレッドシートは管理側でバックアップ運用。

### 6.5 保守性
- Python 3.10+（Dockerは同一系に固定）/ 依存はrequirementsで明示。
- ログ設計、例外ハンドリング、型ヒント、関数分割、コメント最小限。
- 簡易テスト: 主要ロジック（差分処理・パス検証）に単体テスト。

## 7. 外部インターフェース（API）
- GET /login: ログイン画面
- POST /auth/google: Google IDトークン検証（Body: credential）→ 200 {success, redirect} / 4xx/5xx {error}
- GET /: 認証必須のトップ画面
- POST /upload: マルチパート（old_pdf, new_pdf, sensitivity, show_added, show_removed, export_all）→ 200 {output_path, results}
- GET /download/<path:filename>: 出力配下ファイルを添付送信
- GET /status: {authenticated: bool, user: string}

備考: /downloadのfilenameは「出力ディレクトリ内の相対パス」を受け取る設計に統一。

## 8. データ/保存要件
- 一時アップロード: OS一時領域配下に保存し処理後削除。
- 出力保存: static/outputs/{old_vs_new_yyyymmdd_hhmmss}/ 以下に画像とPDF。
- 保持: 既定7日、日次クリーンアップ。閾値（件数/容量）を超えた場合も削除。
- ファイル名: セキュアなファイル名化（secure_filename）、ユーザー提供名とタイムスタンプを組み合わせ。

## 9. デプロイ/構成要件
- 実行環境: Docker/Compose。Webコンテナ（Flask）+ Nginx（SSL終端）。
- 環境変数（例）:
  - SECRET_KEY（Flaskセッション用）
  - GOOGLE_CLIENT_ID（フロントで使用）
  - SERVICE_ACCOUNT_JSON（マウントまたはファイルパス）
  - SHEET_URL（許可ユーザー表）
  - MAX_FILE_SIZE_MB（デフォルト50）
  - OUTPUT_RETENTION_DAYS（デフォルト7）
- ログ: コンテナ標準出力＋ファイル（web_app.log）。
- ヘルスチェック: /status（Nginx/Composeのhealthcheckから参照）。

## 10. 受け入れ基準（例）
- 許可ユーザーのみがログイン可能、期限切れは403。
- 50MB超のPDFはアップロード時に拒否。
- 20ページのPDF2点で60秒以内に処理完了し、差分画像と統合PDFが生成される。
- ダウンロードにディレクトリトラバーサル脆弱性がない（相対パス以外は拒否）。
- 出力ディレクトリが保持期間を超えたファイルを削除（手動/自動いずれか）。
- Docker Composeで起動し、Nginx越しにHTTPSで利用できる。

## 11. リスクと対策
- 秘密情報の露出: リポジトリから除外、環境変数/シークレット管理に移行。
- リソース枯渇: ファイルサイズ・ページ数制限、同時実行制限、レート制限導入。
- PDF脆弱性: 依存ライブラリを最新化、サンドボックス（将来検討）。
- 外部依存（Google API/Sheets）: 失敗時のフォールバック（キャッシュ）とリトライ。

## 12. ロードマップ（初期）
1. セキュリティ是正（秘密情報の分離、ダウンロード安全化、サイズ/レート制限実装）
2. Web UI仕上げ（ダウンロードZIP、エラーメッセージ改善）
3. ログ/監視/保持期間の実装
4. Docker/Compose/Nginx本番化（ヘルスチェック調整、TLS配置）
5. パフォーマンステストと受け入れテスト
6. βリリース → 本番

---

# 既存実装の差分・注意点（現状コード観点）

- /downloadのパス処理: 結果JSONのsummary_pdf/diff_imagesが絶対パスのため、/downloadにそのまま渡すと`static/outputs/static/outputs/...`となり404。相対パスへ正規化して返す、又はサーバ側で正規化＋検証する修正が必要。
- ファイルサイズ制限: MAX_FILE_SIZE定義あり（未使用）。アップロード時に`request.content_length`や個別ファイルサイズ検査を実装する。
- レート制限: README_WEBに記載はあるが未実装。`Flask-Limiter`等で導入。
- ダウンロードの安全性: ディレクトリトラバーサル対策（`os.path.normpath`＋`commonpath`検証）を実装。
- SECRET_KEY: 本番は環境変数から固定値を使用（再起動でセッション無効化しない）。
- Dockerfile healthcheck: `curl`未インストールで失敗。`apt-get install curl`を追加、または`python -c`でのチェックに変更。
- Pythonバージョン整合: ローカル3.12、Docker3.9で乖離。3.10/3.11へ統一を推奨。
- 機密ファイル: `client_service_account.json`や`GoogleClientSecret`を配布物に同梱しない。本番はボリューム/シークレットで供給。

以上。
